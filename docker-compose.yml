# Toolbox MCP Server â€” self-contained deployment
#
# The gateway discovers this container via Docker labels.
# SSH keys are mounted read-only for infra capabilities.
# Secrets are injected via .env on the VM (never committed).

services:
  tailscale:
    image: tailscale/tailscale:v1.80.3
    container_name: toolbox-tailscale
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_EXTRA_ARGS=--hostname=toolbox
    volumes:
      - ./data/tailscale:/var/lib/tailscale
    deploy:
      resources:
        limits:
          memory: 128m
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  toolbox:
    image: ghcr.io/matthewdart/toolbox:latest
    container_name: toolbox
    restart: unless-stopped
    user: "1001"
    group_add:
      - "999"  # docker group GID on Oracle VM
    stdin_open: true  # required for docker exec -i (stdio transport)
    network_mode: service:tailscale
    depends_on:
      - tailscale
    environment:
      - TOOLBOX_TRANSPORT=stdio
      # Secrets sourced from .env on the VM
      - GH_TOKEN
      - OPENAI_API_KEY
    volumes:
      # SSH keys for infra capabilities (read-only)
      - ~/.ssh:/home/toolbox/.ssh:ro
      # Docker socket for push-ghcr capability
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Host /opt for discover_stacks, discover_templates, spawn_instance
      - /opt:/opt:ro
      # Persistent data directory for media downloads etc.
      - ./data:/app/data
    labels:
      mcp.enabled: "true"
      mcp.namespace: "toolbox"
      mcp.transport: "stdio"
      mcp.lifecycle: "persistent"
      mcp.stdio.container: "toolbox"
      mcp.stdio.command: "python"
      mcp.stdio.args: '["-m", "adapters.mcp.server"]'
    deploy:
      resources:
        limits:
          memory: 512m
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
