name: Deploy to VM

on:
  workflow_call:
    inputs:
      services:
        description: "Space-separated list of services to deploy (empty = all)"
        required: false
        type: string
        default: ""
      compose_dir:
        description: "Path to docker-compose.yml directory on the VM"
        required: false
        type: string
        default: /opt/mcp
      vm_hostname:
        description: "Tailscale hostname or IP of the target VM"
        required: false
        type: string
        default: matthews-oracle-instance
    secrets:
      TAILSCALE_AUTHKEY:
        description: "Tailscale auth key (ephemeral, reusable)"
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Pull and deploy
        run: |
          SERVICES="${{ inputs.services }}"
          HOST="${{ inputs.vm_hostname }}"
          DIR="${{ inputs.compose_dir }}"

          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=15 \
              -o BatchMode=yes \
              "$HOST" \
              "cd $DIR && docker compose pull $SERVICES && docker compose up -d $SERVICES"

      - name: Verify deployment
        run: |
          HOST="${{ inputs.vm_hostname }}"
          DIR="${{ inputs.compose_dir }}"
          SERVICES="${{ inputs.services }}"

          echo "=== Service status ==="
          ssh -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              "$HOST" \
              "cd $DIR && docker compose ps $SERVICES"
