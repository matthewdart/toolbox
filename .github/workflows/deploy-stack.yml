name: Deploy to VM

on:
  workflow_call:
    inputs:
      service_name:
        description: "Service name — deploys to /opt/<service_name>/ on the VM"
        required: true
        type: string
      compose_file:
        description: "Path to docker-compose.yml in the calling repo"
        required: false
        type: string
        default: docker-compose.yml
      compose_override_template:
        description: "Path to docker-compose.override template (envsubst placeholders for secrets)"
        required: false
        type: string
        default: docker-compose.override.deploy.yml
      vm_hostname:
        description: "Tailscale hostname or IP of the target VM"
        required: false
        type: string
        default: matthews-oracle-instance
      vm_user:
        description: "SSH user on the target VM"
        required: false
        type: string
        default: ubuntu

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout calling repo
        uses: actions/checkout@v4

      - name: Generate docker-compose.override.yml from template
        env:
          CF_TUNNEL_TOKEN: ${{ secrets.CF_TUNNEL_TOKEN }}
          HTTP_BEARER_TOKEN: ${{ secrets.HTTP_BEARER_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          RM_CONNECT_TOKEN: ${{ secrets.RM_CONNECT_TOKEN }}
        run: |
          TEMPLATE="${{ inputs.compose_override_template }}"
          if [ -f "$TEMPLATE" ]; then
            envsubst < "$TEMPLATE" > docker-compose.override.generated.yml
            echo "✓ override generated from $TEMPLATE"
          else
            echo "No $TEMPLATE found — skipping override generation"
          fi

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Ensure deploy directory exists
        run: |
          HOST="${{ inputs.vm_user }}@${{ inputs.vm_hostname }}"
          DIR="/opt/${{ inputs.service_name }}"
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=15 \
              -o BatchMode=yes \
              "$HOST" \
              "sudo mkdir -p $DIR && sudo chown \$(whoami) $DIR"

      - name: Sync docker-compose.yml to VM
        run: |
          HOST="${{ inputs.vm_user }}@${{ inputs.vm_hostname }}"
          DIR="/opt/${{ inputs.service_name }}"
          scp -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              "${{ inputs.compose_file }}" \
              "$HOST:$DIR/docker-compose.yml"

      - name: Sync docker-compose.override.yml to VM
        run: |
          if [ -f docker-compose.override.generated.yml ]; then
            HOST="${{ inputs.vm_user }}@${{ inputs.vm_hostname }}"
            DIR="/opt/${{ inputs.service_name }}"
            scp -o StrictHostKeyChecking=no \
                -o BatchMode=yes \
                docker-compose.override.generated.yml \
                "$HOST:$DIR/docker-compose.override.yml"
            echo "✓ docker-compose.override.yml synced"
          else
            echo "No override generated — skipping"
          fi

      - name: Pull and deploy
        run: |
          HOST="${{ inputs.vm_user }}@${{ inputs.vm_hostname }}"
          DIR="/opt/${{ inputs.service_name }}"
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=15 \
              -o BatchMode=yes \
              "$HOST" \
              "cd $DIR && docker compose pull && docker compose up -d"

      - name: Verify deployment
        run: |
          HOST="${{ inputs.vm_user }}@${{ inputs.vm_hostname }}"
          DIR="/opt/${{ inputs.service_name }}"
          echo "=== Service status ==="
          ssh -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              "$HOST" \
              "cd $DIR && docker compose ps"
