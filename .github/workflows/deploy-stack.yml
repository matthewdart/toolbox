name: Deploy to VM

on:
  workflow_call:
    inputs:
      service_name:
        description: "Service name — deploys to /opt/<service_name>/ on the VM"
        required: true
        type: string
      compose_file:
        description: "Path to docker-compose.yml in the calling repo"
        required: false
        type: string
        default: docker-compose.yml
      compose_override_template:
        description: "Path to docker-compose.override template (envsubst placeholders for secrets)"
        required: false
        type: string
        default: docker-compose.override.deploy.yml
      vm_hostname:
        description: "Tailscale hostname or IP of the target VM"
        required: false
        type: string
        default: matthews-oracle-instance
      vm_user:
        description: "SSH user on the target VM"
        required: false
        type: string
        default: ubuntu
      up:
        description: "Pull and start containers after deploy (false = pull only)"
        required: false
        type: boolean
        default: true
      health_port:
        description: "Port to poll /health on after deploy (0 = skip health check)"
        required: false
        type: number
        default: 0
      health_timeout:
        description: "Max seconds to wait for /health to return ok or degraded"
        required: false
        type: number
        default: 120

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout calling repo
        uses: actions/checkout@v4

      - name: Generate docker-compose.override.yml from template
        env:
          CF_TUNNEL_TOKEN: ${{ secrets.CF_TUNNEL_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          HTTP_BEARER_TOKEN: ${{ secrets.HTTP_BEARER_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          RM_CONNECT_TOKEN: ${{ secrets.RM_CONNECT_TOKEN }}
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          TEMPLATE="${{ inputs.compose_override_template }}"
          if [ -f "$TEMPLATE" ]; then
            envsubst < "$TEMPLATE" > docker-compose.override.generated.yml
            echo "✓ override generated from $TEMPLATE"
          else
            echo "No $TEMPLATE found — skipping override generation"
          fi

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}

      - name: Ensure deploy directory exists
        run: |
          HOST="${{ inputs.vm_user }}@${{ inputs.vm_hostname }}"
          DIR="/opt/${{ inputs.service_name }}"
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=15 \
              -o BatchMode=yes \
              "$HOST" \
              "sudo mkdir -p $DIR && sudo chown \$(whoami) $DIR"

      - name: Sync docker-compose.yml to VM
        run: |
          HOST="${{ inputs.vm_user }}@${{ inputs.vm_hostname }}"
          DIR="/opt/${{ inputs.service_name }}"
          scp -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              "${{ inputs.compose_file }}" \
              "$HOST:$DIR/docker-compose.yml"

      - name: Sync docker-compose.override.yml to VM
        run: |
          if [ -f docker-compose.override.generated.yml ]; then
            HOST="${{ inputs.vm_user }}@${{ inputs.vm_hostname }}"
            DIR="/opt/${{ inputs.service_name }}"
            scp -o StrictHostKeyChecking=no \
                -o BatchMode=yes \
                docker-compose.override.generated.yml \
                "$HOST:$DIR/docker-compose.override.yml"
            echo "✓ docker-compose.override.yml synced"
          else
            echo "No override generated — skipping"
          fi

      - name: Sync docker-compose.template.yml to VM
        run: |
          TEMPLATE="${{ inputs.compose_file }}"
          TEMPLATE_FILE="$(dirname "$TEMPLATE")/docker-compose.template.yml"
          if [ -f "$TEMPLATE_FILE" ]; then
            HOST="${{ inputs.vm_user }}@${{ inputs.vm_hostname }}"
            DIR="/opt/${{ inputs.service_name }}"
            scp -o StrictHostKeyChecking=no -o BatchMode=yes \
                "$TEMPLATE_FILE" "$HOST:$DIR/docker-compose.template.yml"
            echo "✓ docker-compose.template.yml synced"
          else
            echo "No template file found — skipping"
          fi

      - name: Pull
        run: |
          HOST="${{ inputs.vm_user }}@${{ inputs.vm_hostname }}"
          DIR="/opt/${{ inputs.service_name }}"
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=15 \
              -o BatchMode=yes \
              "$HOST" \
              "cd $DIR && docker compose pull"

      - name: Deploy
        if: inputs.up
        run: |
          HOST="${{ inputs.vm_user }}@${{ inputs.vm_hostname }}"
          DIR="/opt/${{ inputs.service_name }}"
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=15 \
              -o BatchMode=yes \
              "$HOST" \
              "cd $DIR && docker compose up -d"

      - name: Verify deployment
        run: |
          HOST="${{ inputs.vm_user }}@${{ inputs.vm_hostname }}"
          DIR="/opt/${{ inputs.service_name }}"
          echo "=== Service status ==="
          ssh -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              "$HOST" \
              "cd $DIR && docker compose ps"

      - name: Poll health endpoint
        if: inputs.up && inputs.health_port != 0
        run: |
          HOST="${{ inputs.vm_user }}@${{ inputs.vm_hostname }}"
          PORT="${{ inputs.health_port }}"
          TIMEOUT="${{ inputs.health_timeout }}"
          INTERVAL=5
          ELAPSED=0

          CURL_CMD="curl -sS http://localhost:${PORT}/health 2>/dev/null"

          echo "Polling /health on port ${PORT} (timeout ${TIMEOUT}s) ..."
          while [ "$ELAPSED" -lt "$TIMEOUT" ]; do
            RESPONSE=$(ssh -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=5 "$HOST" \
              "$CURL_CMD" || true)

            STATUS=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('status',''))" 2>/dev/null || true)

            if [ "$STATUS" = "ok" ] || [ "$STATUS" = "degraded" ]; then
              echo "✓ Health check passed: status=${STATUS} (after ${ELAPSED}s)"
              echo "$RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$RESPONSE"
              exit 0
            fi

            echo "  ... waiting (${ELAPSED}s/${TIMEOUT}s, status=${STATUS:-no response})"
            sleep "$INTERVAL"
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo "✗ Health check timed out after ${TIMEOUT}s"
          echo "=== Container logs (last 50 lines) ==="
          DIR="/opt/${{ inputs.service_name }}"
          ssh -o StrictHostKeyChecking=no -o BatchMode=yes "$HOST" \
            "cd $DIR && docker compose logs --tail=50" || true
          exit 1
